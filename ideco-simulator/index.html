<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iDeCo ç¯€ç¨ãƒ»è³‡ç”£å½¢æˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<link rel="stylesheet" href="../shared/components.css">
<script src="../shared/base.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   iDeCoå›ºæœ‰ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆå…±é€šå¤‰æ•°ã¯ shared/tokens.cssï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --form-label-w: 220px;
  --card-px:      20px;
}
@media (min-width: 600px) { :root { --card-px: 32px; } }

body {
  font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN W3', 'Hiragino Sans', sans-serif;
  background: var(--base-bg);
  background-image:
    radial-gradient(circle at 15% 20%, rgba(168,213,186,0.18) 0%, transparent 45%),
    radial-gradient(circle at 85% 80%, rgba(74,140,111,0.07) 0%, transparent 45%);
  color: var(--text-main);
  min-height: 100vh;
  padding: 20px 16px 48px;
  max-width: 900px;
  margin: 0 auto;
}
@media (min-width: 640px) { body { padding: 36px 24px 60px; } }

/* â”€â”€ Header â”€â”€ */
header {
  margin-bottom: clamp(20px, 4vw, 32px);
  display: flex; flex-direction: column; align-items: center; text-align: center;
}
.header-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: var(--mint-pale); border: 1px solid var(--mint-light);
  color: var(--accent-deep); font-size: 11px; font-family: 'Roboto Mono', monospace;
  padding: 3px 12px; border-radius: 20px; margin-bottom: 12px; font-weight: 500; letter-spacing: 0.08em;
}
header h1 {
  font-size: clamp(1.3rem, 5vw, 1.9rem); font-weight: 700; color: var(--text-main);
  letter-spacing: 0.04em; margin-bottom: 6px;
}
header p { font-size: clamp(0.75rem, 2.3vw, 0.88rem); color: var(--sub-text); line-height: 1.7; }
.header-br { display: none; }
@media (max-width: 559px) { .header-br { display: block; } }

/* â”€â”€ ds-card ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ â”€â”€ */
.ds-card { padding: 24px var(--card-px) 28px; margin-bottom: 16px; }
@media (min-width: 600px) { .ds-card { padding: 32px var(--card-px); margin-bottom: 20px; } }

.card-label {
  font-size: clamp(0.65rem, 1.9vw, 0.75rem); font-weight: 700;
  letter-spacing: 0.16em; text-transform: uppercase;
  color: var(--placeholder); margin-bottom: clamp(16px, 3vw, 24px);
  display: flex; align-items: center; gap: 8px;
}
.card-label::before {
  content: ''; width: 8px; height: 8px; border-radius: 50%;
  background: var(--accent-deep); flex-shrink: 0;
}

/* â”€â”€ å…¥åŠ›ãƒ‘ãƒ¼ãƒ„ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ â”€â”€ */
.ds-val-row   { align-items: center; margin-bottom: 0; }
.ds-num-edit  { font-size: clamp(1.6rem, 6vw, 2.1rem); width: 86px; letter-spacing: 0.02em; font-weight: 500; }
.ds-val-unit  { font-size: clamp(0.82rem, 2.4vw, 0.95rem); }
.dob-row      { display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap; }
.ds-select-underline { font-size: clamp(1.5rem, 6vw, 2rem); font-weight: 500; }
.ds-select-unit      { font-size: clamp(0.85rem, 2.5vw, 1rem); }
.age-display {
  font-size: clamp(0.75rem, 2.3vw, 0.88rem); color: var(--label-color);
  font-weight: 500; margin-left: 4px; white-space: nowrap;
}
.slider-row { display: flex; align-items: center; gap: 10px; width: 100%; }
.ds-pm-btn {
  width: clamp(30px, 8vw, 34px); height: clamp(30px, 8vw, 34px);
  font-size: clamp(1.1rem, 3.5vw, 1.3rem);
}
.ds-divider { margin: 16px 0; }

/* â”€â”€ è·æ¥­ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ â”€â”€ */
.occ-seg-scroll {
  overflow-x: auto; -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.occ-seg-scroll::-webkit-scrollbar { display: none; }
.occ-seg-scroll .ds-segment { white-space: nowrap; }

.occ-limit {
  display: inline-block; margin-top: 8px;
  font-size: clamp(0.68rem, 2vw, 0.78rem); font-weight: 500; color: var(--accent-deep);
  background: rgba(168,213,186,0.12); border-radius: 8px; padding: 4px 10px;
}

/* â”€â”€ æ‹ å‡ºé¡ã¾ã‚ã‚Š â”€â”€ */
.monthly-preview {
  margin-top: 5px;
  font-size: clamp(0.7rem, 2.1vw, 0.8rem); color: var(--sub-text);
}
.monthly-preview .mval {
  font-family: 'Roboto', sans-serif; font-weight: 600;
  color: var(--accent-deep); font-size: clamp(0.78rem, 2.3vw, 0.88rem);
}
.inline-warn {
  display: none; margin-top: 4px;
  font-size: clamp(0.62rem, 1.8vw, 0.72rem); color: var(--warn-color);
  background: rgba(224,122,58,0.08); border-radius: 8px; padding: 5px 10px;
}
.inline-warn.show { display: block; }

/* â”€â”€ èª²ç¨æ‰€å¾—ãƒ»ç¨ç‡ â”€â”€ */
.tax-row { display: flex; align-items: center; gap: 8px; margin-top: 7px; flex-wrap: wrap; }
.tax-label { font-size: clamp(0.65rem, 1.9vw, 0.75rem); color: var(--sub-text); }
.tax-badge {
  font-size: clamp(0.68rem, 2vw, 0.78rem); font-weight: 600; color: var(--accent-deep);
  background: rgba(168,213,186,0.15); border: 1px solid var(--mint-light);
  border-radius: 20px; padding: 3px 10px;
}

/* â”€â”€ å¹´é‡‘å—å–æœŸé–“ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ â”€â”€ */
.pension-opts {
  overflow: hidden; max-height: 0; opacity: 0;
  transition: max-height 0.35s cubic-bezier(0.22,0.61,0.36,1), opacity 0.25s ease;
}
.pension-opts.show { max-height: 100px; opacity: 1; }
.pension-opts-inner { display: flex; align-items: center; gap: 12px; margin-top: 12px; }
.pension-opts-label { font-size: clamp(0.75rem, 2.2vw, 0.85rem); color: var(--sub-text); }

/* â”€â”€ ã‚µãƒãƒªãƒ¼ã‚°ãƒªãƒƒãƒ‰ï¼ˆ6ã‚«ãƒ¼ãƒ‰ï¼‰â”€â”€ */
.summary {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: clamp(16px, 3.5vw, 24px);
}
@media (min-width: 480px) { .summary { grid-template-columns: repeat(3, 1fr); gap: 14px; } }
@media (max-width: 479px) { .summary .boost-card { grid-column: 1 / -1; } }

/* ãƒ–ãƒ¼ã‚¹ãƒˆé¡ãŒãƒã‚¤ãƒŠã‚¹ã®ã¨ã */
.boost-card.negative { background: rgba(224,122,58,0.06); border-color: var(--warn-color); }
.boost-card.negative .ds-stat-num,
.boost-card.negative .ds-stat-unit { color: var(--warn-color); }
.boost-neg-msg {
  font-size: clamp(0.6rem, 1.8vw, 0.7rem); color: var(--warn-color);
  margin-top: 6px; line-height: 1.5;
}

/* â”€â”€ ã‚°ãƒ©ãƒ• â”€â”€ */
canvas { display: block; cursor: default; }

/* â”€â”€ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆNISA æº–æ‹ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰â”€â”€ */
#tooltip { border-radius: 16px; padding: 14px 18px; min-width: 200px; line-height: 1.9; font-size: clamp(0.72rem, 2.2vw, 0.84rem); }
#tooltip .tt-year  { font-size: clamp(0.82rem, 2.5vw, 0.96rem); }
#tooltip .tt-total { font-size: clamp(0.88rem, 2.8vw, 1.08rem); }

/* â”€â”€ å…è²¬äº‹é … â”€â”€ */
.disclaimer {
  margin-top: 12px; padding: 14px 18px;
  background: rgba(168,213,186,0.08); border-left: 3px solid var(--accent);
  border-radius: 12px; font-size: clamp(0.58rem, 1.8vw, 0.65rem);
  color: var(--sub-text); line-height: 1.8; letter-spacing: 0.04em;
}
@media (min-width: 600px) { .disclaimer { padding: 16px 22px; } }
.disclaimer p + p { margin-top: 6px; }

/* â”€â”€ ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â”€â”€ */
.ds-card { animation: secFadeIn 0.4s cubic-bezier(0.22,0.61,0.36,1) both; }
.ds-card:nth-child(2) { animation-delay: 0.08s; }
.ds-card:nth-child(3) { animation-delay: 0.14s; }
</style>
</head>
<body>

<header>
  <div class="header-badge">ğŸ¦ iDeCoã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
  <h1>iDeCo ç¯€ç¨ãƒ»è³‡ç”£å½¢æˆ<br class="header-br">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
  <p>iDeCoåŠ å…¥ã«ã‚ˆã‚‹ç¨åˆ¶å„ªé‡åŠ¹æœã¨<br class="header-br">è€å¾Œè³‡ç”£ã®å¢—åŠ é¡ã‚’è©¦ç®—ã—ã¾ã™</p>
</header>

<!-- â”€â”€ å…¥åŠ›ã‚«ãƒ¼ãƒ‰ â”€â”€ -->
<div class="ds-card">
  <div class="card-label">å…¥åŠ›æ¡ä»¶</div>
  <div class="ds-form-rows">

    <!-- è·æ¥­ -->
    <div class="ds-form-row">
      <div class="ds-form-row-label">
        <span class="lname">è·æ¥­ãƒ»åŠ å…¥è³‡æ ¼</span>
        <span class="ldesc">å¹´é–“æ‹ å‡ºä¸Šé™ãŒå¤‰ã‚ã‚Šã¾ã™</span>
      </div>
      <div class="ds-form-row-right">
        <div class="occ-seg-scroll">
          <div class="ds-segment" id="occSeg">
            <button class="ds-seg-btn active" data-occ="emp_no">ä¼æ¥­å¹´é‡‘ãªã—<br>ä¼šç¤¾å“¡</button>
            <button class="ds-seg-btn"        data-occ="emp_yes">ä¼æ¥­å¹´é‡‘ã‚ã‚Š<br>ä¼šç¤¾å“¡</button>
            <button class="ds-seg-btn"        data-occ="self">è‡ªå–¶æ¥­</button>
            <button class="ds-seg-btn"        data-occ="public">å…¬å‹™å“¡</button>
          </div>
        </div>
        <div class="occ-limit" id="occLimit"></div>
      </div>
    </div>

    <hr class="ds-divider">

    <!-- ç”Ÿå¹´æœˆæ—¥ -->
    <div class="ds-form-row">
      <div class="ds-form-row-label">
        <span class="lname">ç”Ÿå¹´æœˆæ—¥</span>
        <span class="ldesc">å¹´ãƒ»æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</span>
      </div>
      <div class="ds-form-row-right">
        <div class="dob-row">
          <select id="dobYear"  class="ds-select-underline"></select><span class="ds-select-unit">å¹´</span>
          <select id="dobMonth" class="ds-select-underline"></select><span class="ds-select-unit">æœˆ</span>
          <span class="age-display" id="ageDisplay"></span>
        </div>
      </div>
    </div>

    <hr class="ds-divider">

    <!-- ç©ç«‹çµ‚äº†å¹´é½¢ -->
    <div class="ds-form-row">
      <div class="ds-form-row-label">
        <span class="lname">ç©ç«‹çµ‚äº†å¹´é½¢</span>
        <span class="ldesc">iDeCoæ‹ å‡ºã‚’ç¶šã‘ã‚‹æœ€çµ‚å¹´é½¢</span>
      </div>
      <div class="ds-form-row-right">
        <div class="ds-val-row">
          <input class="ds-num-edit" type="number" id="inEndAge" min="20" max="75" step="1" value="60">
          <span class="ds-val-unit">æ­³</span>
          <span id="yearsDisp" style="font-size:clamp(0.75rem,2.2vw,0.85rem);color:var(--sub-text);margin-left:8px;"></span>
        </div>
        <div class="slider-row">
          <button class="ds-pm-btn" id="endAgeMinus">ï¼</button>
          <input type="range" class="ds-stepper-range" id="slEndAge" min="20" max="75" step="1" value="60">
          <button class="ds-pm-btn" id="endAgePlus">ï¼‹</button>
        </div>
        <div class="inline-warn" id="ageWarn">âš  ç©ç«‹çµ‚äº†å¹´é½¢ãŒç¾åœ¨å¹´é½¢ä»¥ä¸‹ã§ã™ã€‚çµ‚äº†å¹´é½¢ã‚’ä¸Šã’ã¦ãã ã•ã„ã€‚</div>
      </div>
    </div>

    <hr class="ds-divider">

    <!-- å¹´é–“iDeCoæ‹ å‡ºé¡ -->
    <div class="ds-form-row">
      <div class="ds-form-row-label">
        <span class="lname">å¹´é–“iDeCoæ‹ å‡ºé¡</span>
        <span class="ldesc">1å¹´é–“ã®æ›é‡‘åˆè¨ˆ</span>
      </div>
      <div class="ds-form-row-right">
        <div class="ds-val-row">
          <input class="ds-num-edit" type="number" id="inContrib" min="0" max="27.6" step="0.1" value="27.6">
          <span class="ds-val-unit">ä¸‡å††/å¹´</span>
          <div class="ds-chip-scroll" id="contribChips"></div>
        </div>
        <div class="slider-row">
          <button class="ds-pm-btn" id="contribMinus">ï¼</button>
          <input type="range" class="ds-stepper-range" id="slContrib" min="0" max="27.6" step="0.1" value="27.6">
          <button class="ds-pm-btn" id="contribPlus">ï¼‹</button>
        </div>
        <div class="monthly-preview">æœˆã‚ãŸã‚Š <span class="mval" id="monthlyPreview">23,000</span> å††</div>
        <div class="inline-warn" id="contribWarn">âš  ä¸Šé™é¡ã‚’è¶…ãˆã¦ã„ã¾ã™</div>
      </div>
    </div>

    <hr class="ds-divider">

    <!-- æƒ³å®šåˆ©å›ã‚Š -->
    <div class="ds-form-row">
      <div class="ds-form-row-label">
        <span class="lname">æƒ³å®šåˆ©å›ã‚Šï¼ˆå¹´ç‡ï¼‰</span>
      </div>
      <div class="ds-form-row-right">
        <div class="ds-val-row">
          <input class="ds-num-edit" type="number" id="inRate" min="0.1" max="10" step="0.1" value="5">
          <span class="ds-val-unit">%</span>
          <div class="ds-chip-scroll">
            <button class="ds-chip rate-chip" data-value="3">3%</button>
            <button class="ds-chip rate-chip active" data-value="5">5%</button>
            <button class="ds-chip rate-chip" data-value="7">7%</button>
          </div>
        </div>
        <div class="slider-row">
          <button class="ds-pm-btn" id="rateMinus">ï¼</button>
          <input type="range" class="ds-stepper-range" id="slRate" min="0.1" max="10" step="0.1" value="5">
          <button class="ds-pm-btn" id="ratePlus">ï¼‹</button>
        </div>
      </div>
    </div>

    <hr class="ds-divider">

    <!-- èª²ç¨æ‰€å¾— -->
    <div class="ds-form-row">
      <div class="ds-form-row-label">
        <span class="lname">èª²ç¨æ‰€å¾—</span>
        <span class="ldesc">çµ¦ä¸æ‰€å¾—æ§é™¤å¾Œã®æ‰€å¾—é‡‘é¡</span>
      </div>
      <div class="ds-form-row-right">
        <div class="ds-val-row">
          <input class="ds-num-edit" type="number" id="inIncome" min="0" max="5000" step="1" value="500" style="width:94px;">
          <span class="ds-val-unit">ä¸‡å††</span>
          <div class="ds-chip-scroll">
            <button class="ds-chip income-chip" data-value="300">300ä¸‡</button>
            <button class="ds-chip income-chip active" data-value="500">500ä¸‡</button>
            <button class="ds-chip income-chip" data-value="700">700ä¸‡</button>
            <button class="ds-chip income-chip" data-value="1000">1,000ä¸‡</button>
          </div>
        </div>
        <div class="slider-row">
          <button class="ds-pm-btn" id="incomeMinus">ï¼</button>
          <input type="range" class="ds-stepper-range" id="slIncome" min="0" max="5000" step="50" value="500">
          <button class="ds-pm-btn" id="incomePlus">ï¼‹</button>
        </div>
        <div class="tax-row">
          <span class="tax-label">é™ç•Œç¨ç‡ï¼ˆæ‰€å¾—ç¨ï¼‹ä½æ°‘ç¨ï¼‰ï¼š</span>
          <span class="tax-badge" id="taxBadge">â€”</span>
        </div>
      </div>
    </div>

    <hr class="ds-divider">

    <!-- å—å–æ–¹æ³• -->
    <div class="ds-form-row">
      <div class="ds-form-row-label">
        <span class="lname">å—å–æ–¹æ³•</span>
        <span class="ldesc">å—å–æ™‚ã®èª²ç¨æ–¹å¼</span>
      </div>
      <div class="ds-form-row-right">
        <div class="ds-segment" id="receiveSeg">
          <button class="ds-seg-btn active" data-receive="lump">ä¸€æ™‚é‡‘</button>
          <button class="ds-seg-btn"        data-receive="pension">å¹´é‡‘</button>
        </div>
        <div class="pension-opts" id="pensionOpts">
          <div class="pension-opts-inner">
            <span class="pension-opts-label">å—å–æœŸé–“ï¼š</span>
            <div class="ds-segment" id="pensionPeriodSeg">
              <button class="ds-seg-btn active" data-years="10">10å¹´</button>
              <button class="ds-seg-btn"        data-years="15">15å¹´</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â”€â”€ çµæœã‚«ãƒ¼ãƒ‰ â”€â”€ -->
<div class="ds-card" id="resultCard">
  <div class="card-label">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
  <div class="summary" id="summary"></div>
  <div class="ds-chart-legend">
    <div class="ds-chart-li"><div class="ds-chart-ld" style="background:var(--accent)"></div>å…ƒæœ¬</div>
    <div class="ds-chart-li"><div class="ds-chart-ld" style="background:var(--accent-deep)"></div>é‹ç”¨åç›Š</div>
  </div>
  <div class="ds-chart-wrap">
    <canvas id="chart"></canvas>
  </div>
  <div class="ds-chart-note">â€» iDeCoæ‹ å‡ºé¡ã®å¹´æ¬¡æ¨ç§»ï¼ˆç¨å¼•å‰ï¼‰</div>
</div>

<div class="disclaimer">
  <p>ã€è¨ˆç®—ä¸Šã®å‰æãƒ»å…è²¬äº‹é …ã€‘é€€è·æ‰€å¾—æ§é™¤ã¯iDeCoå˜ç‹¬å—å–ã‚’æƒ³å®šã—ãŸç°¡æ˜“è¨ˆç®—ã§ã™ã€‚é€€è·é‡‘ã¨åŒå¹´ã«å—ã‘å–ã‚‹å ´åˆã¯æ§é™¤ãŒé‡è¤‡ã§ãã¾ã›ã‚“ã€‚å¹´é‡‘å—å–ã®å…¬çš„å¹´é‡‘ç­‰æ§é™¤ã¯65æ­³æœªæº€åŸºæº–ï¼ˆç°¡æ˜“ãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚æœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯æ¦‚ç®—ã§ã‚ã‚Šã€ç¨å‹™ä¸Šã®åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  <p>è¡¨ç¤ºã•ã‚Œã‚‹æ•°å€¤ã¯å°†æ¥ã®é‹ç”¨æˆæœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å®Ÿéš›ã®ç¨é¡ãƒ»å—å–é¡ã¯åŠ å…¥å¹´æ•°ãƒ»å—å–æ™‚æœŸãƒ»ä»–ã®æ‰€å¾—ç­‰ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚æŠ•è³‡åˆ¤æ–­ãƒ»ç¨å‹™åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã«ãŠã„ã¦è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„ã€‚</p>
</div>

<div id="tooltip" class="ds-chart-tooltip"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   iDeCo Simulator
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ è·æ¥­ãƒã‚¹ã‚¿ãƒ¼ â”€â”€
const OCC = {
  emp_no:  { maxMan: 27.6, maxMon: 23000, chips: [12000, 18000, 23000] },
  emp_yes: { maxMan: 14.4, maxMon: 12000, chips: [6000,  9000, 12000]  },
  self:    { maxMan: 81.6, maxMon: 68000, chips: [30000, 50000, 68000] },
  public:  { maxMan: 14.4, maxMon: 12000, chips: [6000,  9000, 12000]  },
};

let currentOcc     = 'emp_no';
let currentReceive = 'lump';
let currentPension = 10;

// â”€â”€ æ‰€å¾—ç¨é€Ÿç®—è¡¨ â”€â”€
function incomeTaxFromTable(yen) {
  const m = yen / 10000;
  if (m <= 195)  return yen * 0.05;
  if (m <= 330)  return yen * 0.10 - 97500;
  if (m <= 695)  return yen * 0.20 - 427500;
  if (m <= 900)  return yen * 0.23 - 636000;
  if (m <= 1800) return yen * 0.33 - 1536000;
  if (m <= 4000) return yen * 0.40 - 2796000;
  return           yen * 0.45 - 4796000;
}
function marginalIncomeTaxRate(man) {
  if (man <= 195)  return 0.05;
  if (man <= 330)  return 0.10;
  if (man <= 695)  return 0.20;
  if (man <= 900)  return 0.23;
  if (man <= 1800) return 0.33;
  if (man <= 4000) return 0.40;
  return 0.45;
}
function marginalRate(man) { return marginalIncomeTaxRate(man) + 0.10; }

// â”€â”€ é€€è·æ‰€å¾—æ§é™¤ â”€â”€
function retirementDeduction(n) {
  if (n <= 0)  return 0;
  if (n <= 20) return Math.max(800000, 400000 * n);
  return 8000000 + 700000 * (n - 20);
}

// â”€â”€ å°†æ¥ä¾¡å€¤ï¼ˆå¹´æ¬¡è¤‡åˆ©ï¼‰â”€â”€
function fv(A, r, n) {
  if (n <= 0)  return 0;
  if (r === 0) return A * n;
  return A * ((Math.pow(1 + r, n) - 1) / r);
}

// â”€â”€ DOB â”€â”€
const now          = new Date();
const currentYear  = now.getFullYear();
const currentMonth = now.getMonth() + 1;
const dobYearSel   = document.getElementById('dobYear');
const dobMonthSel  = document.getElementById('dobMonth');

for (let y = currentYear - 18; y >= currentYear - 65; y--) {
  const o = document.createElement('option');
  o.value = y; o.textContent = y;
  dobYearSel.appendChild(o);
}
dobYearSel.value = 1992;
for (let m = 1; m <= 12; m++) {
  const o = document.createElement('option');
  o.value = m; o.textContent = m;
  dobMonthSel.appendChild(o);
}
dobMonthSel.value = 1;

function updateMonthOpts() {
  const y = parseInt(dobYearSel.value);
  Array.from(dobMonthSel.options).forEach(o => {
    const m = parseInt(o.value);
    const am = (currentYear - y) * 12 + (currentMonth - m);
    o.disabled = Math.floor(Math.max(0, am) / 12) >= 65;
  });
  const cur = Array.from(dobMonthSel.options).find(o => parseInt(o.value) === parseInt(dobMonthSel.value));
  if (cur && cur.disabled) {
    const first = Array.from(dobMonthSel.options).find(o => !o.disabled);
    if (first) dobMonthSel.value = first.value;
  }
}
function getAge() {
  const by = parseInt(dobYearSel.value);
  const bm = parseInt(dobMonthSel.value);
  let am = (currentYear - by) * 12 + (currentMonth - bm);
  if (am < 0) am = 0;
  return { ageYears: clamp(Math.floor(am / 12), 18, 64), ageMon: am % 12 };
}
function updateAgeDisplay() {
  const { ageYears, ageMon } = getAge();
  document.getElementById('ageDisplay').textContent =
    `ï¼ˆç¾åœ¨ ${ageYears}æ­³${ageMon > 0 ? ageMon + 'ãƒ¶æœˆ' : ''}ï¼‰`;
  updateYearsDisp();
}
function updateYearsDisp() {
  const { ageYears } = getAge();
  const end = parseInt(document.getElementById('inEndAge').value) || 60;
  const n   = end - ageYears;
  document.getElementById('yearsDisp').textContent = n > 0 ? `â†’ ${n}å¹´é–“` : '';
}

dobYearSel.addEventListener('change',  () => { updateMonthOpts(); updateAgeDisplay(); simulate(); });
dobMonthSel.addEventListener('change', () => { updateAgeDisplay(); simulate(); });
updateMonthOpts();
updateAgeDisplay();

// â”€â”€ ç©ç«‹çµ‚äº†å¹´é½¢ â”€â”€
linkInputs('inEndAge', 'slEndAge', 20, 75, 1, () => { updateYearsDisp(); simulate(); });
document.getElementById('endAgeMinus').addEventListener('click', () => {
  const sl = document.getElementById('slEndAge');
  sl.value = clamp(+sl.value - 1, 20, 75);
  document.getElementById('inEndAge').value = sl.value;
  updateSliderBg(sl); updateYearsDisp(); simulate();
});
document.getElementById('endAgePlus').addEventListener('click', () => {
  const sl = document.getElementById('slEndAge');
  sl.value = clamp(+sl.value + 1, 20, 75);
  document.getElementById('inEndAge').value = sl.value;
  updateSliderBg(sl); updateYearsDisp(); simulate();
});

// â”€â”€ è·æ¥­ â”€â”€
function setOccupation(occ) {
  currentOcc = occ;
  const o = OCC[occ];
  document.getElementById('occLimit').textContent =
    `ä¸Šé™ï¼š${o.maxMan}ä¸‡å††/å¹´ï¼ˆæœˆ ${o.maxMon.toLocaleString('ja-JP')}å††ï¼‰`;
  const sl = document.getElementById('slContrib');
  const inp = document.getElementById('inContrib');
  sl.max  = o.maxMan;
  inp.max = o.maxMan;
  if (parseFloat(inp.value) > o.maxMan) {
    inp.value = o.maxMan.toFixed(1);
    sl.value  = o.maxMan;
  }
  updateSliderBg(sl);
  renderContribChips(occ);
  updateContribUI();
}
function renderContribChips(occ) {
  const cur  = parseFloat(document.getElementById('inContrib').value) || 0;
  const wrap = document.getElementById('contribChips');
  wrap.innerHTML = '';
  OCC[occ].chips.forEach(monthly => {
    const annualMan = parseFloat((monthly * 12 / 10000).toFixed(1));
    const btn = document.createElement('button');
    btn.className = 'ds-chip contrib-chip';
    btn.dataset.val = annualMan;
    btn.textContent = monthly.toLocaleString('ja-JP') + 'å††';
    if (Math.abs(cur - annualMan) < 0.05) btn.classList.add('active');
    btn.addEventListener('click', () => {
      document.getElementById('inContrib').value = annualMan.toFixed(1);
      document.getElementById('slContrib').value = annualMan;
      updateSliderBg(document.getElementById('slContrib'));
      syncContribChips(annualMan); updateContribUI(); simulate();
    });
    wrap.appendChild(btn);
  });
}
function syncContribChips(val) {
  document.querySelectorAll('.contrib-chip').forEach(c =>
    c.classList.toggle('active', Math.abs(parseFloat(c.dataset.val) - val) < 0.05)
  );
}
function updateContribUI() {
  const val     = parseFloat(document.getElementById('inContrib').value) || 0;
  const monthly = Math.round(val * 10000 / 12);
  document.getElementById('monthlyPreview').textContent = monthly.toLocaleString('ja-JP');
  const maxMan = OCC[currentOcc].maxMan;
  const warn   = document.getElementById('contribWarn');
  if (val > maxMan + 0.01) {
    warn.textContent = `âš  ä¸Šé™ï¼ˆ${maxMan}ä¸‡å††/å¹´ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™`;
    warn.classList.add('show');
  } else {
    warn.classList.remove('show');
  }
}

document.getElementById('occSeg').addEventListener('click', e => {
  const btn = e.target.closest('[data-occ]');
  if (!btn) return;
  document.querySelectorAll('#occSeg .ds-seg-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  setOccupation(btn.dataset.occ);
  simulate();
});

// â”€â”€ æ‹ å‡ºé¡ â”€â”€
linkInputs('inContrib', 'slContrib', 0, 27.6, 0.1, () => {
  syncContribChips(parseFloat(document.getElementById('inContrib').value) || 0);
  updateContribUI(); simulate();
});
document.getElementById('contribMinus').addEventListener('click', () => {
  const sl = document.getElementById('slContrib');
  sl.value = clamp(parseFloat(sl.value) - 0.1, 0, OCC[currentOcc].maxMan);
  document.getElementById('inContrib').value = parseFloat(sl.value).toFixed(1);
  updateSliderBg(sl);
  syncContribChips(parseFloat(sl.value)); updateContribUI(); simulate();
});
document.getElementById('contribPlus').addEventListener('click', () => {
  const sl = document.getElementById('slContrib');
  sl.value = clamp(parseFloat(sl.value) + 0.1, 0, OCC[currentOcc].maxMan);
  document.getElementById('inContrib').value = parseFloat(sl.value).toFixed(1);
  updateSliderBg(sl);
  syncContribChips(parseFloat(sl.value)); updateContribUI(); simulate();
});

// â”€â”€ åˆ©å›ã‚Š â”€â”€
linkInputs('inRate', 'slRate', 0.1, 10, 0.1, () => {
  syncRateChips(parseFloat(document.getElementById('inRate').value) || 5);
  simulate();
});
document.getElementById('rateMinus').addEventListener('click', () => {
  const sl = document.getElementById('slRate');
  sl.value = clamp(parseFloat(sl.value) - 0.1, 0.1, 10);
  document.getElementById('inRate').value = parseFloat(sl.value).toFixed(1);
  updateSliderBg(sl); syncRateChips(parseFloat(sl.value)); simulate();
});
document.getElementById('ratePlus').addEventListener('click', () => {
  const sl = document.getElementById('slRate');
  sl.value = clamp(parseFloat(sl.value) + 0.1, 0.1, 10);
  document.getElementById('inRate').value = parseFloat(sl.value).toFixed(1);
  updateSliderBg(sl); syncRateChips(parseFloat(sl.value)); simulate();
});
document.querySelectorAll('.rate-chip').forEach(c => {
  c.addEventListener('click', () => {
    const v = parseFloat(c.dataset.value);
    document.getElementById('inRate').value = v.toFixed(1);
    document.getElementById('slRate').value = v;
    updateSliderBg(document.getElementById('slRate'));
    syncRateChips(v); simulate();
  });
});
function syncRateChips(val) {
  document.querySelectorAll('.rate-chip').forEach(c =>
    c.classList.toggle('active', parseFloat(c.dataset.value) === Math.round(val * 10) / 10)
  );
}

// â”€â”€ èª²ç¨æ‰€å¾— â”€â”€
linkInputs('inIncome', 'slIncome', 0, 5000, 50, () => {
  updateTaxBadge(); syncIncomeChips(parseFloat(document.getElementById('inIncome').value) || 0); simulate();
});
document.getElementById('incomeMinus').addEventListener('click', () => {
  const sl = document.getElementById('slIncome');
  sl.value = clamp(parseFloat(sl.value) - 50, 0, 5000);
  document.getElementById('inIncome').value = sl.value;
  updateSliderBg(sl); updateTaxBadge(); syncIncomeChips(parseFloat(sl.value)); simulate();
});
document.getElementById('incomePlus').addEventListener('click', () => {
  const sl = document.getElementById('slIncome');
  sl.value = clamp(parseFloat(sl.value) + 50, 0, 5000);
  document.getElementById('inIncome').value = sl.value;
  updateSliderBg(sl); updateTaxBadge(); syncIncomeChips(parseFloat(sl.value)); simulate();
});
document.querySelectorAll('.income-chip').forEach(c => {
  c.addEventListener('click', () => {
    const v = parseFloat(c.dataset.value);
    document.getElementById('inIncome').value = v;
    document.getElementById('slIncome').value = v;
    updateSliderBg(document.getElementById('slIncome'));
    updateTaxBadge(); syncIncomeChips(v); simulate();
  });
});
function updateTaxBadge() {
  const man = parseFloat(document.getElementById('inIncome').value) || 0;
  const it  = marginalIncomeTaxRate(man) * 100;
  const t   = marginalRate(man) * 100;
  document.getElementById('taxBadge').textContent =
    `${t.toFixed(0)}%ï¼ˆæ‰€å¾—ç¨ ${it.toFixed(0)}% ï¼‹ ä½æ°‘ç¨ 10%ï¼‰`;
}
function syncIncomeChips(val) {
  document.querySelectorAll('.income-chip').forEach(c =>
    c.classList.toggle('active', parseFloat(c.dataset.value) === val)
  );
}

// â”€â”€ å—å–æ–¹æ³• â”€â”€
document.getElementById('receiveSeg').addEventListener('click', e => {
  const btn = e.target.closest('[data-receive]');
  if (!btn) return;
  document.querySelectorAll('#receiveSeg .ds-seg-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentReceive = btn.dataset.receive;
  document.getElementById('pensionOpts').classList.toggle('show', currentReceive === 'pension');
  simulate();
});
document.getElementById('pensionPeriodSeg').addEventListener('click', e => {
  const btn = e.target.closest('[data-years]');
  if (!btn) return;
  document.querySelectorAll('#pensionPeriodSeg .ds-seg-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentPension = parseInt(btn.dataset.years);
  simulate();
});

// â”€â”€ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â”€â”€
const _prev = {};

function simulate() {
  const { ageYears: age }  = getAge();
  const endAge   = parseInt(document.getElementById('inEndAge').value) || 60;
  const n        = endAge - age;
  const annualMan = parseFloat(document.getElementById('inContrib').value) || 0;
  const annualYen = annualMan * 10000;
  const r         = (parseFloat(document.getElementById('inRate').value)   || 5)   / 100;
  const incomeMan = parseFloat(document.getElementById('inIncome').value)  || 0;
  const t         = marginalRate(incomeMan);

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  document.getElementById('ageWarn').classList.toggle('show', n <= 0);
  if (n <= 0) return;
  const maxMan = OCC[currentOcc].maxMan;
  if (annualMan > maxMan + 0.01) return;

  // â”€â”€ iDeCoã‚ã‚Š â”€â”€
  const FV = fv(annualYen, r, n);

  let receiptTax = 0;
  if (currentReceive === 'lump') {
    // ä¸€æ™‚é‡‘
    const ded      = retirementDeduction(n);
    const retInc   = Math.max(0, FV - ded);
    const taxable  = retInc * 0.5;
    if (taxable > 0) {
      receiptTax = Math.max(0, incomeTaxFromTable(taxable)) + taxable * 0.10;
    }
  } else {
    // å¹´é‡‘
    const annual  = FV / currentPension;
    const ded     = annual <= 1_300_000 ? 700_000 : annual * 0.25 + 375_000;
    const misc    = Math.max(0, annual - ded);
    if (misc > 0) receiptTax = misc * t * currentPension;
  }
  const fvIdeco = Math.max(0, FV - receiptTax);

  // â”€â”€ iDeCoãªã— â”€â”€
  const Anet       = annualYen * (1 - t);
  const fvNonGross = fv(Anet, r, n);
  const gains_non  = Math.max(0, fvNonGross - Anet * n);
  const fvNon      = fvNonGross - gains_non * 0.20315;

  // â”€â”€ å‡ºåŠ›å€¤ â”€â”€
  const boost      = fvIdeco - fvNon;
  const taxSaving  = annualYen * t;
  const burden     = Anet;

  renderSummary({ fvIdeco, fvNon, boost, taxSaving, burden, t, n });

  // â”€â”€ ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ â”€â”€
  const data = [];
  for (let y = 1; y <= n; y++) {
    const fvy = fv(annualYen, r, y);
    data.push({ year: y, age: age + y, principal: annualYen * y, gain: Math.max(0, fvy - annualYen * y), total: fvy });
  }
  renderChart(data);
}

// â”€â”€ ã‚µãƒãƒªãƒ¼æç”» â”€â”€
function renderSummary({ fvIdeco, fvNon, boost, taxSaving, burden, t, n }) {
  const isNeg = boost < 0;
  const svHtml = (v, key) => {
    const { num, unit } = fmtYenParts(Math.abs(v));
    return `<span class="ds-stat-num" data-key="${key}">${v < 0 ? 'âˆ’' : ''}${num}</span>`
         + `<span class="ds-stat-unit" data-key="${key}-u">${unit}</span>`;
  };

  document.getElementById('summary').innerHTML = `
    <div class="ds-stat-card boost-card ${isNeg ? 'negative' : 'highlight'}">
      <div class="ds-stat-label">iDeCoã«ã‚ˆã‚‹è€å¾Œè³‡ç”£ãƒ–ãƒ¼ã‚¹ãƒˆ</div>
      <div class="ds-stat-value">${svHtml(boost, 'boost')}</div>
      ${isNeg ? '<div class="boost-neg-msg">âš  ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯iDeCoãŒä¸åˆ©ã§ã™</div>' : ''}
    </div>
    <div class="ds-stat-card">
      <div class="ds-stat-label">iDeCoã‚ã‚Šæœ€çµ‚é¡ï¼ˆç¨å¼•å¾Œï¼‰</div>
      <div class="ds-stat-value">${svHtml(fvIdeco, 'fideco')}</div>
    </div>
    <div class="ds-stat-card">
      <div class="ds-stat-label">iDeCoãªã—æœ€çµ‚é¡</div>
      <div class="ds-stat-value">${svHtml(fvNon, 'fnon')}</div>
    </div>
    <div class="ds-stat-card">
      <div class="ds-stat-label">å¹´é–“ç¯€ç¨é¡</div>
      <div class="ds-stat-value">${svHtml(taxSaving, 'taxsave')}</div>
    </div>
    <div class="ds-stat-card">
      <div class="ds-stat-label">å®Ÿè³ªè² æ‹…é¡ï¼ˆå¹´é–“ï¼‰</div>
      <div class="ds-stat-value">${svHtml(burden, 'burden')}</div>
    </div>
    <div class="ds-stat-card">
      <div class="ds-stat-label">é™ç•Œç¨ç‡</div>
      <div class="ds-stat-value">
        <span class="ds-stat-num" style="font-size:clamp(1.4rem,5vw,2rem)">${(t * 100).toFixed(0)}</span>
        <span class="ds-stat-unit">%</span>
      </div>
    </div>
  `;

  [['boost', boost], ['fideco', fvIdeco], ['fnon', fvNon], ['taxsave', taxSaving], ['burden', burden]]
    .forEach(([key, val]) => {
      const numEl  = document.querySelector(`.ds-stat-num[data-key="${key}"]`);
      const unitEl = document.querySelector(`.ds-stat-unit[data-key="${key}-u"]`);
      if (!numEl) return;
      const from = _prev[key] ?? 0;
      animateNum(numEl, from, Math.abs(val), 700, cur => {
        const { num, unit } = fmtYenParts(Math.round(cur));
        if (unitEl) unitEl.textContent = unit;
        return (val < 0 ? 'âˆ’' : '') + num;
      });
      _prev[key] = Math.abs(val);
    });
}

// â”€â”€ ã‚°ãƒ©ãƒ• â”€â”€
let bars = [];
let hoveredIdx = -1;

function rRect(ctx, x, y, w, h, r) {
  if (h <= 0 || w <= 0) return;
  if (typeof r === 'number') r = [r,r,r,r];
  ctx.beginPath();
  ctx.moveTo(x+r[0], y);
  ctx.lineTo(x+w-r[1], y); ctx.quadraticCurveTo(x+w, y, x+w, y+r[1]);
  ctx.lineTo(x+w, y+h-r[2]); ctx.quadraticCurveTo(x+w, y+h, x+w-r[2], y+h);
  ctx.lineTo(x+r[3], y+h); ctx.quadraticCurveTo(x, y+h, x, y+h-r[3]);
  ctx.lineTo(x, y+r[0]); ctx.quadraticCurveTo(x, y, x+r[0], y);
  ctx.closePath(); ctx.fill();
}

function renderChart(data) {
  const isMobile   = window.innerWidth < 560;
  const MOBILE_MAX = 20;
  const hiIdx      = hoveredIdx;
  const canvas     = document.getElementById('chart');
  const dpr        = window.devicePixelRatio || 1;
  const containerW = canvas.parentElement.clientWidth;
  const n          = data.length;

  const PAD = { t: 14, r: isMobile ? 6 : 14, b: isMobile ? 34 : 42, l: isMobile ? 6 : 64 };
  let cW;
  if (isMobile && n > MOBILE_MAX) {
    cW = Math.ceil(PAD.l + PAD.r + ((containerW - PAD.l - PAD.r) / MOBILE_MAX) * n);
  } else {
    cW = containerW;
  }

  const plotW = cW - PAD.l - PAD.r;
  const BAR   = Math.max(3, plotW / n - Math.max(1, Math.min(4, plotW / n * 0.28)));
  const GAP   = Math.max(1, plotW / n - BAR);
  const H     = isMobile ? 220 : 300;
  const pH    = H - PAD.t - PAD.b;

  canvas.width  = cW * dpr; canvas.height = H * dpr;
  canvas.style.width = cW + 'px'; canvas.style.height = H + 'px';

  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, cW, H);

  const maxVal    = Math.max(...data.map(d => d.total), 1);
  const labelStep = isMobile ? 10 : 5;

  for (let i = 0; i <= 4; i++) {
    const y = PAD.t + pH - pH * i / 4;
    ctx.strokeStyle = '#deeee8'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(PAD.l, y); ctx.lineTo(cW - PAD.r, y); ctx.stroke();
    if (!isMobile) {
      ctx.fillStyle = '#7a9a8e';
      ctx.font = '500 10px Roboto, sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText(fmtAxisYen(maxVal * i / 4), PAD.l - 6, y + 3.5);
    }
  }

  bars = data.map((d, i) => {
    const x       = PAD.l + i * (BAR + GAP);
    const baseY   = PAD.t + pH;
    const totalH  = (d.total     / maxVal) * pH;
    const princH  = (d.principal / maxVal) * pH;
    const gainH   = totalH - princH;
    const isHov   = i === hiIdx;

    if (isHov) {
      ctx.fillStyle = 'rgba(74,140,111,0.09)';
      ctx.beginPath();
      if (ctx.roundRect) ctx.roundRect(x - 3, PAD.t, BAR + 6, pH, 5);
      else               ctx.rect(x - 3, PAD.t, BAR + 6, pH);
      ctx.fill();
    }

    ctx.fillStyle = isHov ? '#7ec9a0' : '#a8d5ba';
    rRect(ctx, x, baseY - princH, BAR, princH, [0, 0, 4, 4]);
    if (gainH > 0.5) {
      ctx.fillStyle = isHov ? '#3a7a5f' : '#4a8c6f';
      rRect(ctx, x, baseY - totalH, BAR, gainH, [4, 4, 0, 0]);
    }

    if (d.year === 1 || d.year % labelStep === 0 || d.year === data.length) {
      ctx.fillStyle = '#7a9a8e';
      ctx.font = isMobile ? '500 8.5px Roboto, sans-serif' : '500 9.5px Roboto, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(d.age + 'æ­³', x + BAR / 2, H - PAD.b + 13);
      ctx.strokeStyle = '#d4ede3'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(x + BAR / 2, baseY); ctx.lineTo(x + BAR / 2, baseY + 4); ctx.stroke();
    }

    return { ...d, _x: x, _w: BAR };
  });
}

// â”€â”€ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— â”€â”€
const tip = document.getElementById('tooltip');

function onPointer(e) {
  const canvas = document.getElementById('chart');
  const rect   = canvas.getBoundingClientRect();
  const cx = e.touches ? e.touches[0].clientX : e.clientX;
  const cy = e.touches ? e.touches[0].clientY : e.clientY;
  const lx = (cx - rect.left) * (parseFloat(canvas.style.width) / rect.width);

  const idx = bars.findIndex(b => lx >= b._x - 3 && lx <= b._x + b._w + 3);
  if (idx < 0) {
    if (hoveredIdx !== -1) { hoveredIdx = -1; renderChart(bars); }
    tip.classList.remove('show'); return;
  }
  if (hoveredIdx !== idx) { hoveredIdx = idx; renderChart(bars); }

  const d = bars[idx];
  tip.innerHTML = `
    <div class="tt-year">${d.year}å¹´å¾Œï¼ˆ${d.age}æ­³ï¼‰</div>
    <div class="tt-total">åˆè¨ˆï¼š${fmtYen(d.total)}</div>
    <div class="tt-sep"></div>
    <div class="tt-row"><div class="tt-dot" style="background:#a8d5ba"></div>å…ƒæœ¬ï¼š${fmtYen(d.principal)}</div>
    <div class="tt-row"><div class="tt-dot" style="background:#4a8c6f"></div>é‹ç”¨åç›Šï¼š${fmtYen(d.gain)}</div>
  `;

  const TW = 220, TH = 140;
  let tx = cx + 16, ty = cy - 20;
  if (tx + TW > window.innerWidth)  tx = cx - TW - 16;
  if (tx < 4) tx = 4;
  if (ty + TH > window.innerHeight) ty = cy - TH - 10;
  if (ty < 4) ty = 4;
  tip.style.left = tx + 'px'; tip.style.top = ty + 'px';
  tip.classList.add('show');
}
function hideTip() {
  if (hoveredIdx !== -1) { hoveredIdx = -1; if (bars.length) renderChart(bars); }
  tip.classList.remove('show');
}

const cvs = document.getElementById('chart');
cvs.addEventListener('mousemove',  onPointer);
cvs.addEventListener('mouseleave', hideTip);
let _touchMoved = false;
cvs.addEventListener('touchstart', e => { _touchMoved = false; onPointer(e); }, { passive: true });
cvs.addEventListener('touchmove',  e => { _touchMoved = true; hideTip(); },   { passive: true });
cvs.addEventListener('touchend',   e => { if (_touchMoved) hideTip(); },      { passive: true });
window.addEventListener('resize', () => { if (bars.length) renderChart(bars); });

// â”€â”€ åˆæœŸåŒ– â”€â”€
setOccupation('emp_no');
updateTaxBadge();
initChipScroll();
simulate();
</script>
</body>
</html>
